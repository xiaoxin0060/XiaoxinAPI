# å°æ–°APIç½‘å…³é…ç½®æ–‡ä»¶
# æ”¯æŒè¿‡æ»¤å™¨æ¶æ„åˆ‡æ¢å’Œè¯¦ç»†çš„åŠŸèƒ½é…ç½®

spring:
  application:
    name: xiaoxin-api-gateway
  cloud:
    gateway:
      # å…¨å±€CORSé…ç½®
      server:
        webflux:
          globalcors:
            cors-configurations:
              '[/**]':
                          allowedOrigins: "*"
                          allowedMethods: "*"
                          allowedHeaders: "*"
                          maxAge: 3600
          default-filters:
            - AddResponseHeader=source, xiaoxin
          routes:
            # æ•è·æ‰€æœ‰/api/**è¯·æ±‚ï¼ŒURIä¸ºå ä½ç¬¦ï¼Œå®é™…è½¬å‘åœ¨GlobalFilterä¸­å¤„ç†
                    - id: dynamic_proxy_route
                      uri: no://op
                      predicates:
                        - Path=/api/**
  # Redisé…ç½®ã€ç½‘å…³ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“
  data:
    redis:
      host: localhost
      port: 9736
      database: 2
      timeout: 5000
      lettuce:
        pool:
          max-active: 8
          max-wait: -1
          max-idle: 8
          min-idle: 0

server:
  port: 9999

# å°æ–°ç½‘å…³è‡ªå®šä¹‰é…ç½®
xiaoxin:
  gateway:
    # ğŸš€ æ¶æ„åˆ‡æ¢å¼€å…³ - æ§åˆ¶ä½¿ç”¨æ–°æ¶æ„è¿˜æ˜¯æ—§æ¶æ„
    new-architecture:
      enabled: true  # true=æ–°æ¶æ„(æ¨è), false=æ—§æ¶æ„(å…¼å®¹)
    
    # è¿‡æ»¤å™¨å¼€å…³é…ç½®ï¼ˆç»†ç²’åº¦æ§åˆ¶ï¼‰
    filters:
      logging: true              # æ—¥å¿—è®°å½•è¿‡æ»¤å™¨
      security: true             # å®‰å…¨è¿‡æ»¤å™¨ï¼ˆIPç™½åå•ï¼‰
      authentication: true       # è®¤è¯è¿‡æ»¤å™¨ï¼ˆç­¾åéªŒè¯ï¼‰
      interface-validation: true # æ¥å£éªŒè¯è¿‡æ»¤å™¨
      rate-limit: true           # é™æµè¿‡æ»¤å™¨
      quota: true                # é…é¢è¿‡æ»¤å™¨
      proxy: true                # ä»£ç†è¿‡æ»¤å™¨
      response: true             # å“åº”å¤„ç†è¿‡æ»¤å™¨

    # å®‰å…¨ç›¸å…³é…ç½®
    security:
      # IPç™½åå•ï¼ˆæ”¯æŒå•IPå’ŒCIDRç½‘æ®µï¼‰
      ip-whitelist:
        - "127.0.0.1"            # æœ¬åœ°å›ç¯
        - "0:0:0:0:0:0:0:1"      # IPv6æœ¬åœ°å›ç¯
        - "::1"                  # IPv6ç®€åŒ–å›ç¯
      
      # ç­¾åéªŒè¯é…ç½®
      signature-timeout-seconds: 300  # ç­¾åæœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
      nonce-length: 16               # nonceé•¿åº¦ï¼ˆå­—ç¬¦ï¼‰
      enable-timestamp-validation: true    # å¯ç”¨æ—¶é—´æˆ³éªŒè¯
      enable-replay-protection: true       # å¯ç”¨é˜²é‡æ”¾æ”»å‡»

    # é™æµé…ç½®
    rate-limit:
      enabled: true              # é™æµåŠŸèƒ½æ€»å¼€å…³
      window-seconds: 60         # æ»‘åŠ¨çª—å£å¤§å°ï¼ˆç§’ï¼‰
      default-limit: 1000        # é»˜è®¤é™æµå€¼ï¼ˆæ¬¡/çª—å£ï¼‰
      redis-key-prefix: "xiaoxin:rate_limit"  # Redis keyå‰ç¼€
      key-expire-seconds: 75     # Redis keyè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰

    # ä»£ç†é…ç½®
    proxy:
      default-timeout-ms: 30000  # é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      default-retry-count: 3     # é»˜è®¤é‡è¯•æ¬¡æ•°
      enable-metrics: true       # å¯ç”¨æŒ‡æ ‡æ”¶é›†
      enable-request-logging: true  # å¯ç”¨è¯·æ±‚æ—¥å¿—

    # æ–­è·¯å™¨é…ç½®ï¼ˆé˜²é›ªå´©æœºåˆ¶ï¼‰
    circuit-breaker:
      enabled: true              # æ–­è·¯å™¨åŠŸèƒ½æ€»å¼€å…³
      failure-threshold: 5       # å¤±è´¥é˜ˆå€¼ï¼ˆæ¬¡ï¼‰- 5æ¬¡å¤±è´¥åç†”æ–­
      window-minutes: 5          # ç»Ÿè®¡çª—å£ï¼ˆåˆ†é’Ÿï¼‰- ç»Ÿè®¡æœ€è¿‘5åˆ†é’Ÿçš„å¤±è´¥
      open-timeout-minutes: 1    # ç†”æ–­æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰- 1åˆ†é’Ÿåå…è®¸æ¢æµ‹
      redis-key-prefix: "xiaoxin:circuit"    # Redis keyå‰ç¼€
      redis-key-expire-minutes: 15           # Redis keyè¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰

# Dubboé…ç½®
dubbo:
  registry:
    address: nacos://127.0.0.1:8848?username=nacos&password=nacos
    register-mode: instance
  protocol:
    name: tri
    port: 50052
  application:
    qos-enable: false
    name: gateway
    qos-port: 22224
    qos-accept-foreign-ip: false
    logger: slf4j

# å®‰å…¨é…ç½®
security:
  authcfg:
    # å»ºè®®é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼šexport AUTHCFG_MASTER_KEY=your_32_byte_key
    master-key: ${AUTHCFG_MASTER_KEY:0123456789ABCDEF0123456789ABCDEF}

# æ—¥å¿—é…ç½®
logging:
  level:
    com.xiaoxin.api.gateway: DEBUG
    org.springframework.cloud.gateway: INFO
    reactor.netty: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"